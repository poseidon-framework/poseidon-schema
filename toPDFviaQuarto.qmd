---
title: Poseidon package specification
format:
  pdf:
    #keep-tex: true
    toc: true
    colorlinks: true
#### section layout ####
    number-sections: true
    shift-heading-level-by: -1
#### page layout ####
    documentclass: article
    papersize: a4paper
    geometry:
      - top=30mm
      - left=20mm
      - heightrounded
#### code layout ####
    highlight-style: tango
#### detailed configuration ####
    include-in-header: 
       text: |
         % wrap long code lines
         \usepackage{fvextra}
         \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
         % get more control over table cells
         % \usepackage{makecell}
include-before-body:
  text: |
    % also necessary to wrap long code lines
    \RecustomVerbatimEnvironment{verbatim}{Verbatim}{
      showspaces = false,
      showtabs = false,
      breaksymbolleft={},
      breaklines
      % Note: setting commandchars=\\\{\} here will cause an error 
    }
    % turn off page numbers
    \pagenumbering{gobble}
    % roman section headers
    \renewcommand{\thesection}{\Alph{section}}
    \renewcommand{\thesubsection}{\Roman{subsection}}
    \renewcommand{\thesubsubsection}{\thesubsection.\roman{subsubsection}}
    \renewcommand{\arraystretch}{1.5}
---

<!-- can be rendered with "quarto render toPDFviaQuarto.qmd --to pdf" -->

{{< include README.md >}}

\newpage

## Appendix 1: POSEIDON.yml file fields

```{r}
#| echo: false
library(magrittr)
# build table with kableExtra
make_tab <- function(x, caption) {
  x %>%
    kableExtra::kbl(caption = caption, longtable = T, booktabs = T, escape = FALSE) %>%
    kableExtra::kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header")) %>%
    kableExtra::column_spec(1, width = "18em") %>%
    kableExtra::column_spec(2, width = "30em")
}
# construct cell with linebreak
lb <- \(x) kableExtra::linebreak(x)
# newline
n <- \(...) {
    purrr::pmap_chr(list(...), \(...) {
      # omit NA rows
      rows <- na.omit(unlist(list(...)))
      paste(rows, collapse = "\n")
    })
  }
#n <- \(x, y) paste(x, y, sep = "\n")
# bold
b <- \(x) paste0("\\textbf{", x, "}")
# underscore
u <- \(x) paste0("\\underline{", x, "}")
# named argument
a <- \(name,x) ifelse(!is.na(x), paste0(u(name), ": ", x), NA_character_)
# "" to NA
toNA <- \(x) ifelse(x == "", NA_character_, x)
```

```{r}
#| echo: false
raw <- readr::read_tsv(
  file = "POSEIDON_yml_fields.tsv",
  show_col_types = FALSE
)
raw %>%
  dplyr::transmute(
    Field = paste0(b(field), ifelse(mandatory, "\\textsuperscript{\\ast}", "")),
    Description = lb(n(
      description,
      a("subfield of", parent),
      a("type", type),
      a("format", format)
    ))
  ) %>% make_tab(caption = "POSEIDON.yml file fields")
  
```

\newpage

## Appendix 2: .janno file variables

```{r}
#| echo: false
raw <- readr::read_tsv(
  file = "janno_columns.tsv",
  show_col_types = FALSE
)
raw %>%
  # handle underscores
  dplyr::mutate(dplyr::across(tidyselect::where(is.character), \(x) toNA(Hmisc::latexTranslate(x)))) %>%
  dplyr::transmute(
    Variable = paste0(b(janno_column_name), ifelse(mandatory, "\\textsuperscript{\\ast}", "")),
    Description = lb(n(
      description,
      ifelse(multi, u("list column"), NA_character_),
      a("type", data_type),
      a("allowed values", choice_options),
      a("allowed range", ifelse(!is.na(range_lower), paste(range_lower, "to", range_upper), NA_character_))
    ))
  ) %>% make_tab(caption = ".janno file variables")
```

\newpage

## Appendix 3: .ssf file variables

```{r}
#| echo: false
raw <- readr::read_tsv(
  file = "ssf_columns.tsv",
  show_col_types = FALSE
)
raw %>%
  # handle underscores
  dplyr::mutate(dplyr::across(tidyselect::where(is.character), \(x) toNA(Hmisc::latexTranslate(x)))) %>%
  dplyr::transmute(
    Variable = paste0(b(sequencingSourceFile_column_name), ifelse(mandatory, "\\textsuperscript{\\ast}", "")),
    Description = lb(n(
      description,
      ifelse(multi, u("list column"), NA_character_),
      a("type", data_type),
      a("allowed values", choice_options),
      a("allowed range", ifelse(!is.na(range_lower), paste(range_lower, "to", range_upper), NA_character_))
    ))
  ) %>% make_tab(caption = ".ssf file variables")
```
